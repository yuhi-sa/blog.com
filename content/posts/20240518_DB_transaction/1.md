---
title: "トランザクションの分離レベルと防げる不整合"
date: 2024-05-18T09:10:00+09:00
draft: false
tags: ["DB", "トランザクション"]
description: "データベースのトランザクション分離レベル（READ UNCOMMITTED〜SERIALIZABLE）と、各レベルで防げるデータ不整合について解説します。"
---

<!--more-->

データベースにおける**トランザクション**は、一連の操作を一つの論理的な単位として扱い、すべて成功するか、すべて失敗するかのいずれかであることを保証する仕組みです。複数のトランザクションが同時に実行される環境では、データの整合性を保つために**分離レベル（Isolation Level）**が重要になります。

## データベースのトランザクション処理で問題となる不整合

複数のトランザクションが並行して動作する際に発生しうる代表的なデータ不整合の現象です。

### 1. ダーティリード (Dirty Read)

- **現象**: あるトランザクションAが、**別のトランザクションBによって変更されたが、まだコミットされていないデータ**を読み取ってしまう現象です。
- **問題点**: もしトランザクションBが後でロールバックされた場合、トランザクションAが読み取ったデータは実際には存在しない無効なデータとなり、データの信頼性が損なわれます。

### 2. ノンリピータブルリード (Non-repeatable Read)

- **現象**: あるトランザクションAが同じデータを複数回読み取る際に、その間に**別のトランザクションBによってデータが更新（または削除）され、異なる結果が返される**現象です。
- **問題点**: トランザクションA内で一貫性のないデータが提供されることになり、トランザクションの信頼性や処理結果の正確性が低下します。

### 3. ファントムリード (Phantom Read)

- **現象**: 特定の条件でクエリを実行して結果を得た後、同じクエリを再実行した際に、その間に**別のトランザクションによって条件に合致する新たな行が追加されたり、既存の行が削除されたりして、異なる結果セットが返される**現象です。
- **問題点**: データセットの整合性が保たれず、集計処理や条件に基づくデータ操作で予期せぬ結果を招く可能性があります。

## トランザクションの分離レベル

ANSI/ISO SQL標準では、これらの不整合を防ぐために、以下の4つの分離レベルが定義されています。分離レベルが上がるほど、防げる不整合の種類が増えますが、並行性が低下し、パフォーマンスへの影響が大きくなる可能性があります。

### 1. `READ UNCOMMITTED`

- **防げる不整合**: なし
- **特徴**: 最も低い分離レベルです。ダーティリード、ノンリピータブルリード、ファントムリードのすべてが発生する可能性があります。パフォーマンスは最も高いですが、データの一貫性はほとんど保証されません。

### 2. `READ COMMITTED`

- **防げる不整合**: `Dirty Read`
- **特徴**: 他のトランザクションが**コミットした後のデータのみ**を読み取ります。これにより、未コミットのデータによるダーティリードは防げます。しかし、ノンリピータブルリードやファントムリードは発生する可能性があります。多くのデータベースシステムでデフォルトの分離レベルとして採用されています。

### 3. `REPEATABLE READ`

- **防げる不整合**: `Dirty Read`, `Non-repeatable Read`
- **特徴**: トランザクションが開始された時点で読み取ったデータは、そのトランザクションが終了するまで他のトランザクションによる変更から保護されます。これにより、同じトランザクション内でのデータの再読み取りが一貫します（ノンリピータブルリードを防ぎます）。しかし、ファントムリードは発生する可能性があります。

### 4. `SERIALIZABLE`

- **防げる不整合**: `Dirty Read`, `Non-repeatable Read`, `Phantom Read`
- **特徴**: 最も厳格な分離レベルです。トランザクションが他のトランザクションとは完全に独立して（直列に）実行されたかのように動作することを保証します。これにより、上記3つの不整合のすべてを防ぐことができます。しかし、並行性が大幅に低下し、パフォーマンスへの影響が最も大きくなる可能性があります。

### `SNAPSHOT` 分離レベル (一部のDBシステムで提供)

- **防げる不整合**: `Dirty Read`, `Non-repeatable Read`, `Phantom Read`
- **特徴**: `SERIALIZABLE` と同等のデータ一貫性を持ちながら、より高い並行性を実現するために、一部のデータベースシステム（例: SQL Server, Oracle）で提供される分離レベルです。トランザクションが開始された時点のデータベースの**スナップショット**が作成され、トランザクションはそのスナップショットに対して操作を行います。これにより、他のトランザクションによる変更が現在のトランザクションに影響を与えることはありません。

アプリケーションの要件（データの一貫性、パフォーマンス、並行性）に応じて、適切な分離レベルを選択することが重要です。

## 参考

- [MySQL 8.0 Reference Manual: InnoDB Transaction Isolation Levels](https://dev.mysql.com/doc/refman/8.0/ja/innodb-transaction-isolation-levels.html)
- [Prisma ORM: Transactions](https://www.prisma.io/docs/orm/prisma-client/queries/transactions)
- [トランザクション分離レベル - Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB)
